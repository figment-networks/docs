---
title: Building Subgraphs on Cosmos Hub
---

This guide is an introduction on building subgraphs indexing the [Cosmos Hub blockchain](https://hub.cosmos.network/).

## What is Cosmos Hub?

[Cosmos](https://cosmos.network/) is an ecosystem of blockchains that can scale and interoperate with each other. Cosmos Hub is the first blockchain in the ecosystem. You can visit the [official documentation](https://docs.cosmos.network/) for more information.

## What are Cosmos subgraphs?

Cosmos subgraphs are a new type of subgraph that [Graph Node](https://github.com/graphprotocol/graph-node) is now able to process. This allows to index and store data inside the Cosmos Hub blockchain, and make that resulting data easily available via GraphQL API.

Cosmos subgraphs will differ from other implementations, such as Ethereum, in that there is no need to specify a smart contract from which events and data will be indexed from. In this case, Graph Node is monitoring all data appended to the chain.

There are currently three types of handlers supported for the Cosmos Hub subgraphs:

- Block handlers.
- [Event](https://docs.cosmos.network/master/core/events.html) handlers.
- [Transaction](https://docs.cosmos.network/master/core/transactions.html) handlers.

Based on the [official Cosmos documentation](https://docs.cosmos.network/):

> Events are objects that contain information about the execution of the application. They are mainly used by service providers like block explorers and wallet to track the execution of various messages and index transactions.

> Transactions are objects created by end-users to trigger state changes in the application.

## Building a Cosmos Hub subgraph

### Subgraph Dependencies

[graph-cli](https://github.com/graphprotocol/graph-cli) is a CLI tool to build and deploy subgraphs, version `>=0.23.0` is required in order to work with Cosmos Hub subgraphs.

[graph-ts](https://github.com/graphprotocol/graph-ts) is a library of subgraph-specific types, version `>=0.23.0` is required in order to work with Cosmos Hub subgraphs.

### Subgraph Main Components

There are three main key parts or files when it comes to define a subgraph:

**subgraph.yaml**: a YAML file containing the subgraph manifest.

**schema.graphql**: a GraphQL schema that defines what data is stored for your subgraph, and how to query it via GraphQL.

**AssemblyScript Mappings**: [AssemblyScript](https://github.com/AssemblyScript/assemblyscript) code that translates from the event data to the entities defined in your schema.

### Subgraph Manifest Definition

The subgraph manifest (`subgraph.yaml`) identifies the data sources for the subgraph, the triggers of interest, and the functions that should be run in response to those triggers. See below for an example subgraph manifest for a Cosmos Hub subgraph:

```yaml
specVersion: 0.0.2
description: Cosmos Subgraph Example
schema:
  file: ./schema.graphql # link to the schema file
dataSources:
  - kind: cosmos
    network: cosmoshub-4
    source:
      startBlock: 0 # Required for Cosmos, set this to 0 to start indexing from chain genesis
    mapping:
      apiVersion: 0.0.5
      language: wasm/assemblyscript
      blockHandlers:
        - handler: handleNewBlock # the function name in the mapping file
      eventHandlers:
        - event: rewards # the type of the event that will be handled
          handler: handleReward # the function name in the mapping file
      transactionHandlers:
        - handler: handleTransaction # the function name in the mapping file
      file: ./src/mapping.ts # link to the file with the Assemblyscript mappings
```

- Cosmos Hub subgraphs introduce a new `kind` of data source (`cosmos`).
- The `network` should correspond to a network on the hosting Graph Node. Cosmos Hub mainnet is `cosmoshub-4`. Other Cosmos Hub networks, i.e. `cosmoshub-3`, are halted, therefore no data is provided for them.

Cosmos Hub data sources support three types of handlers:

- `blockHandlers`: run on every new block appended to the chain. The handler will receive a full block and all its data containing, among other things, all the events and transactions.
- `eventHandlers`: run on every event, except if there is an event type specified in the handler definition, in that case only events of that type are processed. Block data is also passed onto the mapping in order to have context of the event within the chain.
- `transactionHandlers`: run for every transaction executed. The mapping is provided with all the relevant data related to the transaction and a block abstraction that can be used to acquire context of the transaction within a block and within the chain.

Event and Transaction handlers are a way to process meaningful data from the chain without the need of processing a whole block. The data processed by them can also be found in the block handlers, since events and transactions are also part of a block, but removes the need of processing unnecessary data.

### Schema Definition

Schema definition describes the structure of the resulting subgraph database, and the relationships between entities. This is agnostic of the original data source. There are more details on subgraph schema definition [here](https://thegraph.com/docs/en/developer/create-subgraph-hosted/#the-graph-ql-schema).

### AssemblyScript Mappings

The handlers for processing events are written in [AssemblyScript](https://www.assemblyscript.org/).

Cosmos Hub indexing introduces Cosmos-specific data types to the [AssemblyScript API](https://thegraph.com/docs/en/developer/assemblyscript-api/).

```tsx
class EventList {
    newBlock: EventBlock
    transaction: Array<EventTx>
    validatorSetUpdates: EventValidatorSetUpdates
}

class EventData {
    event: Event
    block: EventBlock
}

class TransactionData {
    tx: TxResult
    block: EventBlock
}

class EventBlock {
    block: Block
    blockId: BlockID
    resultBeginBlock: ResponseBeginBlock
    resultEndBlock: ResponseEndBlock
}

class EventTx {
		txResult: TxResult
}

class TxResult {
		height: u64
    index: u32
    tx: Bytes
    result: ResponseDeliverTx
    hash: Bytes
}

class Event {
    eventType: string
    attributes: Array<EventAttribute>
}
```

The types above are just the general ones that mappings use. You can find the full list of types for the Cosmos Hub integration [here](https://github.com/graphprotocol/graph-ts/blob/main/chain/tendermint.ts).

Each type of handler will receive a different type based on the relevant data. For both event and transaction handlers, a reference to the block they are contained in is passed as well. These are the exact types that are passed as a parameter to each mapping function:

`EventList` is passed to the blockHandler.

`EventData` is passed to the eventHandler.

`TransactionData` is passed to the transactionHandler.

## Creating and building a Cosmos Hub subgraph

The first step before starting to write the subgraph mappings is to generate the type bindings based on the entities that have been defined in the subgraph schema file (`schema.graphql`). This will allow the mapping functions to create new objects of those types and save them to the store. This is done by using the `codegen` CLI command:

```bash
$ graph codegen
```

Once the mappings are ready, the subgraph needs to be built. This step will highlight any errors the manifest or the mappings might have. A subgraph needs to build successfully in order to be deployed to the Graph Node. It can be done using the `build` CLI command:

```bash
$ graph build
```

## Deploying a Cosmos Hub subgraph

When the subgraph builds successfully, it is time to deploy it to a Graph Node instance for indexing. Cosmos subgraphs can be deployed to any Graph Node on version `>=v0.26.x`.

The first thing to do is create the subgraph in the node, this only has to be done once via the `create` CLI command:

```bash
$ graph create subgraph-name --node <graph-node-url>
```

After the subgraph has been created, it can be deployed by using the graph `deploy` CLI command:

```bash
$ graph deploy subgraph-name --ipfs <ipfs-url> --node <graph-node-url>
```

Once your subgraph has been deployed, it will be indexed by Graph Node. You can check its progress by querying the subgraph itself at the exposed endpoint.

## Querying a Cosmos Hub subgraph

The GraphQL endpoint for Cosmos Hub subgraphs is determined by the schema definition, with the existing API interface. Please visit the [GraphQL API documentation](https://thegraph.com/docs/en/developer/graphql-api/) for more information.

## Example Subgraphs

Here are some example subgraphs for reference:

Cosmos Hub Block Subgraph

Cosmos Hub Event Subgraph

Cosmos Hub Transaction Subgraph
